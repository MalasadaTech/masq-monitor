<header>
    <h1>Masquerade Monitor Report</h1>
    <div class="meta">
        <!-- Display title based on TLP level if available, otherwise fallback to query name -->
        {% set report_title = None %}
        {% set title_tlp = None %}
        {% if query_data.titles %}
            {% for title_item in query_data.titles %}
                {% if title_item.tlp_level == tlp_level %}
                    {% set report_title = title_item.title %}
                    {% set title_tlp = title_item.tlp_level %}
                {% endif %}
            {% endfor %}
            
            <!-- If no exact TLP match, use best available title based on TLP order -->
            {% if not report_title %}
                {% set tlp_order = {'clear': 1, 'white': 1, 'green': 2, 'amber': 3, 'red': 4} %}
                {% set report_tlp_value = tlp_order[tlp_level]|default(1) %}
                {% set available_titles = [] %}
                
                {% for title_item in query_data.titles %}
                    {% set title_tlp_value = tlp_order[title_item.tlp_level]|default(1) %}
                    {% if title_tlp_value <= report_tlp_value %}
                        {% set _ = available_titles.append((title_tlp_value, title_item.title, title_item.tlp_level)) %}
                    {% endif %}
                {% endfor %}
                
                {% if available_titles|length > 0 %}
                    {% set available_titles = available_titles|sort(reverse=true) %}
                    {% set report_title = available_titles[0][1] %}
                    {% set title_tlp = available_titles[0][2] %}
                {% endif %}
            {% endif %}
        {% endif %}
        
        <p class="report-title">
            {% if report_title %}
                {% if title_tlp %}
                    <span class="tlp portion-marking tlp-{{ title_tlp }}">TLP:{{ title_tlp }}</span>
                {% endif %}
                <strong>{{ report_title }}</strong>
            {% else %}
                <span class="tlp portion-marking tlp-{{ tlp_level }}">TLP:{{ tlp_level }}</span>
                <strong>{{ query_name }}</strong>
            {% endif %}
        </p>
        <p>Generated: {{ timestamp }}</p>
        {% if username %}
        <p>Generated by: <strong>{{ username }}</strong></p>
        {% endif %}
        <p>TLP Level: <span class="tlp tlp-{{ tlp_level }}">TLP:{{ tlp_level }}</span></p>
    </div>
</header>